
# WealFlow API and Application Documentation

## Обзор проекта

**WealFlow** - это комплексное финансовое приложение, состоящее из REST API на Go (Fiber, MongoDB) и клиентского Single Page Application (SPA) на React (TypeScript, Vite). Приложение предоставляет функциональность для управления финансовыми транзакциями с поддержкой аутентификации через JWT токены и OAuth (Google через Auth0). Клиентская часть обеспечивает пользовательский интерфейс для взаимодействия с API.

### Технический стек

#### Бэкенд (Backend)
- **Язык программирования**: Go
- **Web-фреймворк**: Fiber v2
- **База данных**: MongoDB
- **Аутентификация**: JWT, OAuth 2.0 (Google/Auth0)
- **Документация API**: Swagger/OpenAPI

#### Клиентская часть (Frontend)
- **Язык/Библиотека**: TypeScript, React (v19)
- **Сборщик/Инструменты**: Vite
- **Управление состоянием**: React Query (`@tanstack/react-query`), React Context (`AuthContext`, `ThemeContext`)
- **Маршрутизация**: React Router DOM
- **UI**: Tailwind CSS, Framer Motion, Lucide React
- **Аутентификация (клиент)**: `@auth0/auth0-react`
- **Визуализация данных**: Recharts
- **Стилизация**: PostCSS, Autoprefixer

---

## Архитектура приложения

### Структура проекта (Бэкенд - WealFlow API)
```
WealFlow/
├── main.go                           # Точка входа приложения
├── auth/
│   ├── authController.go            # Контроллеры аутентификации
│   └── googleAuth0.go               # OAuth интеграция
├── database/
│   └── database.go                  # Подключение к MongoDB
├── middleware/
│   ├── jwtMiddleware.go             # JWT middleware
│   └── tokenService.go              # Сервис работы с токенами
├── models/
│   └── models.go                    # Модели данных Go
└── transactions/
    └── transactionController.go     # Контроллеры транзакций
```

### Структура проекта (Клиент - wealflow-app)
```
wealflow-app/
├── public/                            # Статические ассеты
├── src/
│   ├── components/                    # Переиспользуемые компоненты (UI, auth, statistics, transactions)
│   │   ├── auth/
│   │   ├── common/
│   │   ├── dashboard/
│   │   ├── statistics/
│   │   └── transactions/              # Включая functions.ts для API-запросов через React Query
│   ├── context/                       # AuthContext, ThemeContext
│   ├── layouts/                       # MainLayout (основной макет с Sidebar и Header)
│   ├── pages/                         # Основные страницы (AuthPage, DashboardPage, TransactionsPage, etc.)
│   ├── App.tsx                        # Корневой компонент приложения с маршрутизацией
│   ├── main.tsx                       # Точка входа React-приложения, инициализация QueryClient
│   ├── index.css                      # Глобальные стили и Tailwind CSS
│   └── types.ts                       # TypeScript типы для данных (User, Transaction, etc.)
├── .env                               # Переменные окружения для Vite
├── vite.config.ts                     # Конфигурация Vite
├── tailwind.config.js                 # Конфигурация Tailwind CSS
└── package.json                       # Зависимости и скрипты
```

### Основные компоненты

#### 1. **Модели данных** (`models/models.go` для бэкенда, `src/types.ts` для фронтенда)

**User** - модель пользователя (Go):
```go
type User struct {
    ID       primitive.ObjectID `json:"id,omitempty" bson:"_id,omitempty"`
    Name     string             `json:"name"`
    Email    string             `json:"email"`
    Password []byte             `json:"password"` // Хешированный пароль для 'common' провайдера
    Provider string             `bson:"provider"` // 'common' или 'google'
}
```
*На фронтенде (`src/types.ts`) определен аналогичный тип `User` для работы с данными пользователя.*

**Transaction** - модель финансовой транзакции (Go):
```go
type Transaction struct {
    ID          primitive.ObjectID `json:"id,omitempty" bson:"_id,omitempty"`
    UserID      primitive.ObjectID `json:"user_id,omitempty" bson:"user_id,omitempty"`
    Date        primitive.DateTime `json:"date,omitempty" bson:"date,omitempty"`
    Description string             `json:"description,omitempty" bson:"description,omitempty"`
    Category    string             `json:"category,omitempty" bson:"category,omitempty"`
    Amount      float64            `json:"amount,omitempty" bson:"amount,omitempty"`
    Type        bool               `json:"type,omitempty" bson:"type,omitempty"` // true - доход, false - расход
}
```
*На фронтенде (`src/types.ts`) определен аналогичный тип `Transaction` (и `NewTransactionData` для создания) для работы с транзакциями.*

#### 2. **Бэкенд API** (`WealFlow/`)
- Реализован на Go с использованием Fiber.
- Предоставляет RESTful эндпоинты для аутентификации и управления транзакциями.
- Взаимодействует с MongoDB.

#### 3. **Клиентское приложение** (`wealflow-app/`)
- SPA на React и TypeScript, созданное с помощью Vite.
- **Пользовательский интерфейс**: Реализован с помощью компонентов React, стилизованных Tailwind CSS. Включает страницы для аутентификации, дашборда, управления транзакциями, просмотра статистики и настроек.
- **Управление состоянием**:
    - `React Query` для получения, кэширования и обновления серверных данных (транзакции, пользователь).
    - `React Context` (`AuthContext`, `ThemeContext`) для глобального состояния аутентификации и темы оформления.
- **Маршрутизация**: `React Router DOM` для навигации между страницами (`AuthPage`, `DashboardPage` и др.).
- **Взаимодействие с API**: Асинхронные запросы к бэкенд API для всех операций с данными. Обернуты в хуки React Query (например, в `src/components/transactions/functions.ts`).
- **Аутентификация**:
    - Формы для входа/регистрации по email/паролю.
    - Интеграция с Auth0 (`@auth0/auth0-react`) для OAuth (Google). Фронтенд обрабатывает редирект на Auth0, получает токен и отправляет его на бэкенд (`/api/auth/google`) для верификации и создания сессии.
- **Визуализация**: Компонент `ChartContainer` с использованием `Recharts` для отображения статистики.

#### 4. **База данных** (`database/database.go`)

- **MongoDB подключение** через переменную окружения `MONGODB_URI`
- **Коллекции**: `users`, `transactions`
- **Автоматическое создание индекса** по полю `userId` для оптимизации запросов
- **База данных**: `golang_db`

#### 5. **Система аутентификации** (Бэкенд и Клиент)

**JWT токены** (управляются бэкендом, используются клиентом):
- **Access Token** - короткоживущий токен для API запросов
- **Refresh Token** - долгоживущий токен для обновления access token
- Токены хранятся в HTTP-only куки для безопасности, автоматически отправляются браузером.

**Провайдеры аутентификации**:
- `common` - регистрация/вход по email/паролю (формы на клиенте, обработка на бэкенде).
- `google` - OAuth через Google/Auth0 (поток инициируется клиентом, токен верифицируется бэкендом).
- Клиент использует `AuthContext` для управления состоянием аутентификации и `ProtectedRoute` для защиты маршрутов.

---

## API Endpoints

### Аутентификация (`/api/auth`)

#### 1. Регистрация пользователя
**POST** `/api/auth/register`

**Описание**: Регистрация нового пользователя с email и паролем

**Тело запроса**:
```json
{
  "name": "Имя пользователя",
  "email": "user@example.com",
  "password": "пароль"
}
```

**Ответы**:
- `200` - Успешная регистрация
- `400` - Email уже зарегистрирован или некорректные данные
- `500` - Внутренняя ошибка сервера

#### 2. Авторизация пользователя
**POST** `/api/auth/login`

**Описание**: Вход в систему по email и паролю

**Тело запроса**:
```json
{
  "email": "user@example.com",
  "password": "пароль"
}
```

**Ответы**:
- `200` - Успешная авторизация
- `400` - Неверный пароль
- `404` - Пользователь не найден

#### 4. Обновление email и имени
**GET** `/api/auth/update`

**Описание**: Изменение информации о текущем пользователе

**Аутентификация**: Требуется access_token в куки

**Тело запроса**:
```json
{
  "name": "Имя пользователя",
  "email": "user@example.com"
}
```

**Ответы**:
- `200` - Данные пользователя
- `400` - Невалидный токен
- `404` - Пользователь не найден

#### 5. Обновление пароля
**POST** `/api/auth/google`

**Описание**: Проверяет соответствие старого пароля и позволяет задать новый

**Тело запроса**:
```json
{
  "password": "пароль",
  "newPassword": "новый пароль"
}
```

**Ответы**:
- `200` - Успешная авторизация
- `400` - Невалидный токен
- `401` - Ошибка верификации токена

#### 6. OAuth авторизация
**POST** `/api/auth/google`

**Описание**: Авторизация через Google OAuth

**Тело запроса**:
```json
{
  "token": "oauth_token_from_google"
}
```

**Ответы**:
- `200` - Успешная авторизация
- `400` - Невалидный токен
- `401` - Ошибка верификации токена

#### 7. Выход из системы
**POST** `/api/auth/logout`

**Описание**: Удаление токенов из куки

**Ответы**:
- `200` - Успешный выход

#### 8. Обновление токена
**POST** `/api/auth/refresh`

**Описание**: Обновление access токена используя refresh токен

**Аутентификация**: Требуется refresh_token в куки

**Ответы**:
- `200` - Новый access токен установлен
- `401` - Невалидный refresh токен

### Транзакции (`/api/transactions`)

**Все эндпоинты требуют аутентификации (JWT middleware)**

#### 1. Получение списка транзакций
**GET** `/api/transactions`

**Описание**: Получение всех транзакций текущего пользователя

**Ответы**:
- `200` - Массив транзакций
- `401` - Не авторизован
- `500` - Ошибка сервера

**Пример ответа**:
```json
[
  {
    "id": "507f1f77bcf86cd799439011",
    "user_id": "507f1f77bcf86cd799439012",
    "date": "2025-06-20T10:30:00Z",
    "description": "Покупка продуктов",
    "category": "Еда",
    "amount": 1500.50,
    "type": false
  }
]
```

#### 2. Создание транзакции
**POST** `/api/transactions`

**Описание**: Создание новой финансовой транзакции

**Тело запроса**:
```json
{
  "description": "Описание транзакции",
  "category": "Категория",
  "amount": 1000.00,
  "type": true,
  "date": "2025-06-20T10:30:00Z" // необязательно
}
```

**Ответы**:
- `201` - Транзакция создана
- `400` - Некорректные данные
- `401` - Не авторизован
- `500` - Ошибка сервера

#### 3. Обновление транзакции
**PATCH** `/api/transactions/:id`

**Описание**: Частичное обновление существующей транзакции

**Параметры пути**:
- `id` - ID транзакции

**Тело запроса** (все поля необязательны):
```json
{
  "description": "Новое описание",
  "category": "Новая категория",
  "amount": 2000.00,
  "type": false,
  "date": "2025-06-20T15:30:00Z"
}
```

**Ответы**:
- `200` - Транзакция обновлена
- `400` - Некорректные данные или ID
- `401` - Не авторизован
- `404` - Транзакция не найдена
- `500` - Ошибка сервера

#### 4. Удаление транзакции
**DELETE** `/api/transactions/:id`

**Описание**: Удаление транзакции

**Параметры пути**:
- `id` - ID транзакции

**Ответы**:
- `200` - Транзакция удалена
- `400` - Некорректный ID
- `401` - Не авторизован
- `404` - Транзакция не найдена
- `500` - Ошибка сервера
---


---

## Безопасность

### JWT Аутентификация
- **Access Token**: Срок действия настраивается через `ACCESS_EXPIRE_MINUTES`
- **Refresh Token**: Срок действия настраивается через `REFRESH_EXPIRE_HOURS`
- Токены хранятся в HTTP-only куки с флагами `Secure` и `SameSite`. Клиентское приложение автоматически отправляет их с запросами к API.

### OAuth 2.0
- Интеграция с Auth0 для Google OAuth.
- Клиентское приложение (`wealflow-app`) использует библиотеку `@auth0/auth0-react` для управления процессом OAuth.
- Клиент получает `id_token` от Auth0 и отправляет его на бэкенд эндпоинт `/api/auth/google`.
- Бэкенд верифицирует JWT токен от Auth0 через JWKS endpoint.
- Автоматическое создание пользователей на бэкенде при первом входе через OAuth.

### Защита данных
- Пароли хешируются с использованием bcrypt (на бэкенде).
- Проверка принадлежности транзакций пользователю (на бэкенде).
- CORS настройки на бэкенде для разрешения запросов с фронтенд домена.
- На фронтенде используются `ProtectedRoute` для ограничения доступа к страницам на основе статуса аутентификации.

---

## Переменные окружения

### Бэкенд (файл `.env` в корне проекта бэкенда):
```env
# База данных
MONGODB_URI=mongodb://localhost:27017/

# JWT секреты
ACCESS_SECRET=your_access_secret_key
REFRESH_SECRET=your_refresh_secret_key

# Время жизни токенов
ACCESS_EXPIRE_MINUTES=15
REFRESH_EXPIRE_HOURS=168

# OAuth (Auth0 - используется для валидации токенов с фронтенда)
AUTH0_DOMAIN=your-auth0-domain.auth0.com # Домен Auth0 (без https://)

# Настройки окружения
ENV=development # или production
PORT=5000       # Порт, на котором запускается бэкенд
FRONTEND_ORIGIN=http://localhost:5173 # URL фронтенд-приложения для CORS
COOKIE_DOMAIN=localhost
```

### Клиент (файл `.env` в корне проекта клиента `wealflow-app/`):
```env
# URL бэкенд API
VITE_API_URL=http://localhost:5000

# Auth0 настройки для клиентского приложения
VITE_AUTH0_DOMAIN=your-auth0-domain.auth0.com
VITE_AUTH0_CLIENT_ID=your_auth0_client_id
VITE_AUTH0_REDIRECT_URI=http://localhost:5173/home # URI, на который Auth0 перенаправит после аутентификации
VITE_AUTH0_AUDIENCE= # Если используется для API Authorization в Auth0
```
*Примечание: `AUTH0_DOMAIN` в бэкенде и `VITE_AUTH0_DOMAIN` на клиенте должны указывать на один и тот же тенант Auth0.*

---

## Middleware (Бэкенд)

### JWT Middleware
- **Назначение**: Проверка валидности access токена на бэкенде.
- **Применение**: Ко всем эндпоинтам `/api/transactions` и защищенным эндпоинтам `/api/auth`.
- **Функциональность**: Извлечение и валидация токена из куки, сохранение userID в контексте запроса.

### CORS Middleware
- **Настройки**: Разрешенные origins (включая `FRONTEND_ORIGIN`), methods, headers.
- **Credentials**: Поддержка куки в кросс-доменных запросах.

---

## Обработка ошибок (Бэкенд API)

### Стандартные коды ответов:
- `200` - Успешный запрос
- `201` - Ресурс создан
- `400` - Некорректный запрос
- `401` - Не авторизован
- `404` - Ресурс не найден
- `500` - Внутренняя ошибка сервера

### Формат ошибок (от API):
```json
{
  "error": "Описание ошибки"
}
```
*Клиентское приложение получает эти ошибки и отображает их пользователю или обрабатывает соответствующим образом.*

### Формат успешных ответов (от API, пример):
```json
{
  "success": true,
  "message": "Описание операции"
  // ... другие данные, если применимо
}
```

---

## Развертывание

### Бэкенд (API)

#### Development
```bash
# Установка зависимостей (в директории бэкенда)
go mod tidy

# Запуск в режиме разработки
ENV=development go run main.go
```

#### Production
```bash
# Сборка (в директории бэкенда)
go build -o wealflow main.go

# Запуск
ENV=production ./wealflow
```

### Клиентское приложение (Frontend)

#### Development
```bash
# Перейдите в директорию клиентского приложения (например, wealflow-app)
cd wealflow-app
# Установка зависимостей
npm install
# Запуск в режиме разработки (обычно на порту 5173, настроено в vite.config.ts)
npm run dev
```

#### Production
```bash
# Перейдите в директорию клиентского приложения
cd wealflow-app
# Сборка статических файлов (обычно в директорию dist)
npm run build
# Собранные статические файлы затем могут быть развернуты с помощью Nginx, Apache, CDN
# или интегрированы в бэкенд Go для раздачи из одной точки.
```

### Docker (рекомендуется - пример для совместного развертывания)
Предполагается следующая структура проекта для Docker:
```
project-root/
├── backend/      # Код бэкенда Go
│   ├── main.go
│   └── ...
├── frontend/     # Код фронтенда React
│   ├── src/
│   └── package.json
└── Dockerfile    # Dockerfile в корне проекта
```

```dockerfile
# --- Backend Build Stage ---
FROM golang:1.21-alpine AS backend-builder
WORKDIR /app
COPY ./backend/go.mod ./backend/go.sum ./
RUN go mod download
COPY ./backend/ ./
# Важно! Убедитесь, что переменные окружения для сборки (если есть) доступны здесь
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o /app/wealflow main.go

# --- Frontend Build Stage ---
FROM node:18-alpine AS frontend-builder
WORKDIR /app
COPY ./frontend/package.json ./frontend/package-lock.json ./
RUN npm install
COPY ./frontend/ ./
# Важно! Передайте VITE_API_URL и другие VITE_ переменные как аргументы сборки, если они нужны на этапе сборки фронтенда
# Пример: RUN npm run build -- --base=/app/ --mode production
RUN npm run build # Результат в /app/dist

# --- Final Stage ---
FROM alpine:latest
WORKDIR /app/
# Копируем исполняемый файл бэкенда
COPY --from=backend-builder /app/wealflow .
# Копируем собранные статические файлы фронтенда
# Предполагается, что Go-сервер будет настроен на раздачу статики из ./static/
# или вы используете Nginx перед Go-сервером.
COPY --from=frontend-builder /app/dist ./static

# Файл .env для бэкенда НЕ должен копироваться в образ. Переменные должны передаваться при запуске контейнера.
# EXPOSE 5000 (порт бэкенда)

# Команда для запуска Go приложения.
# Go приложение должно быть настроено на раздачу статики из ./static
# или перед ним должен стоять Nginx/другой веб-сервер.
CMD ["./wealflow"]
```
*Примечание: Приведенный Dockerfile является примером. Настройка раздачи статики и переменных окружения может потребовать доработки в зависимости от вашей конфигурации Go-сервера (например, использование Fiber для раздачи статики из `./static`).*

---

## Мониторинг и логирование (Бэкенд)

### Логирование
- Подробные логи операций с базой данных
- Логирование ошибок аутентификации
- Отслеживание операций с транзакциями

### Health Check эндпоинты
- `/dev/access` - проверка access токена (только для разработки)
- `/dev/refresh` - проверка refresh токена (только для разработки)

*На фронтенде логирование осуществляется через консоль браузера. Для production можно интегрировать Sentry или аналогичный сервис.*

---

## Расширение функциональности

### Возможные улучшения (Общие):
1.  **Пагинация** для списка транзакций (реализация на бэкенде, поддержка на фронтенде).
2.  **Фильтрация и сортировка** транзакций (расширение API, UI на фронтенде).
3.  **Категории** как отдельная сущность (CRUD для категорий на бэкенде и фронтенде).
4.  **Статистика и аналитика** (новые эндпоинты на бэкенде, новые графики/отчеты на фронтенде).
5.  **Уведомления** (система на бэкенде, отображение на фронтенде).
6.  **API версионирование**.
7.  **Rate limiting** (на бэкенде).
8.  **Caching слой** (на бэкенде, например, Redis).
9.  **Улучшения UI/UX** на фронтенде (анимации, доступность).
10. **Progressive Web App (PWA)** функциональность для фронтенда.

### Масштабирование:
- Горизонтальное масштабирование бэкенда через load balancer.
- Шардинг MongoDB по пользователям.
- Redis для кеширования сессий/данных.
- CDN для статических ресурсов фронтенда.

---

## Контакты и поддержка

**Разработчик**: Карачебан Дмитрий
**Email**: iikardev@gmail.com
**Лицензия**: MIT

---

*Документация дополнена на основе анализа исходного кода клиентской части и существующей документации бэкенда.*
